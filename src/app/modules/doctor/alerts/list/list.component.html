<ngx-spinner></ngx-spinner>
<div class="alert-list-page inner-scroll">
    <div class="section-header mb-5">
        <h2>Alerts</h2>
    </div>

    <div *ngIf="Message" class="toast-container {{ MessageClass }}">
        <p>{{ Message }}</p>
    </div>
    <div class="filter-section lg:flex-nowrap mb-3">
        <h3>Filter by</h3>
        <div class="badge-filter">
            <div class="badge-input">
                <mat-checkbox
                    class="example-margin"
                    color="primary"
                    [(ngModel)]="alertallChecked"
                    (change)="alertFilterChange('all')"
                    >All</mat-checkbox
                >
                <span class="badge"> {{ totalAlert }} </span>
            </div>

            <div class="badge-input">
                <mat-checkbox
                    class="example-margin"
                    color="primary"
                    (change)="alertFilterChange('unresolve')"
                    [(ngModel)]="alertunresolveChecked"
                    >Unresolved Alerts</mat-checkbox
                >
                <span class="badge"> {{ unresolvecount }} </span>
            </div>

            <div class="badge-input">
                <mat-checkbox
                    class="example-margin"
                    color="primary"
                    (change)="alertFilterChange('resolve')"
                    [(ngModel)]="alertresolveChecked"
                    >Resolved Alerts</mat-checkbox
                >
                <span class="badge"> {{ resolvecount }} </span>
            </div>

            <!-- <div class="badge-input">
                <mat-checkbox class="example-margin" color="primary"
                    >Blood Pressure</mat-checkbox
                >
                <span class="badge"> 1 </span>
            </div>

            <div class="badge-input">
                <mat-checkbox class="example-margin" color="primary"
                    >Weight</mat-checkbox
                >
                <span class="badge"> 1 </span>
            </div> -->
        </div>
    </div>
    <div class="filter-section mb-3">
        <div class="section-filters mb-0">
            <div class="search-field mr-6 flex">
                <mat-form-field>
                    <input
                        matInput
                        #searchInputAlert
                        placeholder="Enter a Patient Name/ID"
                        (keyup)="searchfn($event)"
                    />
                    <mat-icon matSuffix>
                        <img src="../../../../assets/search.svg" alt="" />
                    </mat-icon>
                </mat-form-field>
            </div>
            <mat-form-field
                appearance="fill"
                class="outline-input period-picker"
            >
                <mat-date-range-input
                    [formGroup]="rangeAlert"
                    [rangePicker]="pickerAlert"
                    [max]="todayDate"
                >
                    <input
                        matStartDate
                        formControlName="start"
                        #dateRangeStart
                        placeholder="Select Period"
                        readonly
                    />
                    <input
                        matEndDate
                        formControlName="end"
                        #dateRangeEnd
                        (dateChange)="
                            alertDateRangeChange(dateRangeStart, dateRangeEnd)
                        "
                        readonly
                    />
                </mat-date-range-input>
                <mat-datepicker-toggle matSuffix [for]="pickerAlert">
                    <img
                        matDatepickerToggleIcon
                        style="width: 15px"
                        src="../../../../../assets/calendar.svg"
                        alt=""
                    />
                </mat-datepicker-toggle>
                <!-- <mat-icon matDatepickerToggleIcon>keyboard_arrow_down</mat-icon> -->

                <mat-date-range-picker #pickerAlert></mat-date-range-picker>
            </mat-form-field>

            <button
                mat-stroked-button
                class="outline-btn reset-btn ml-5"
                matTooltip="Reset"
                (click)="resetForm(dateRangeStart, dateRangeEnd)"
            >
                Reset
            </button>
            <button
                mat-stroked-button
                class="outline-btn reset-btn ml-5"
                (click)="resolveAlerts()"
                matTooltip="Resolve"
            >
                Resolve
            </button>
        </div>
        <div class="select-filter-container ml-auto">
            <mat-form-field style="width: 9.375rem">
                <mat-label>Sort By</mat-label>
                <mat-select
                    (selectionChange)="altfilterChange($event.value, 'sortBy')"
                    [(ngModel)]="requestParamAlert.sortBy"
                >
                    <mat-option value="asc"> Oldest </mat-option>
                    <mat-option value="desc"> Newest </mat-option>
                    <mat-option value="pasc"> Patient Name A-Z </mat-option>
                    <mat-option value="pdesc"> Patient Name Z-A </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
    </div>
    <div class="table-container">
        <div class="table-wrapper">
            <div class="table-block">
                <ngx-datatable
                    class="material fullscreen"
                    [rows]="(serverResponseAlert | async) || []"
                    [headerHeight]="$any('auto')"
                    [footerHeight]="0"
                    rowHeight="auto"
                    [scrollbarH]="true"
                    [externalPaging]="true"
                    [count]="page1.totalElements"
                    [offset]="page1.pageNumber"
                    [limit]="page1.size"
                    (page)="setPage($event)"
                    (sort)="onSort($event)"
                    [selected]="selectedData"
                            [selectionType]="SelectionType.checkbox"
                            [selectAllRowsOnPage]="false"
                            (select)="onSelect($event)"
                >
                    <ngx-datatable-column
                        [width]="60"
                        [sortable]="false"
                        [canAutoResize]="false"
                        [draggable]="false"
                        [resizeable]="false"
                        [headerCheckboxable]="false"
                        [checkboxable]="false"
                    >
                        <ng-template
                            ngx-datatable-header-template
                            let-value="value"
                            let-allRowsSelected="allRowsSelected"
                            let-selectFn="selectFn"
                        >
                            <mat-checkbox
                                color="primary"
                                [checked]="allRowsSelected"
                                (change)="selectFn(!allRowsSelected)"
                                style="margin-left: 8px"
                            ></mat-checkbox>
                        </ng-template>
                        <ng-template
                            ngx-datatable-cell-template
                            let-value="value"
                            let-isSelected="isSelected"
                            let-onCheckboxChangeFn="onCheckboxChangeFn"
                        >
                            <mat-checkbox
                                color="primary"
                                [checked]="isSelected"
                                (change)="onCheckboxChangeFn($event)"
                                ng-model="selectedData[record.patientMRN]"
                                style="margin-left: 8px"
                            ></mat-checkbox>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Last alert" [width]="150">
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            {{ row.last_alert | date: "dd/MM/yyyy" }}
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Patient Details" [width]="300">
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <div class="avatar-detail-col">
                                <!-- <img
                                            class="avatar"
                                            src="assets/images/avatars/doctor.jpg"
                                            alt=""
                                        /> -->
                                <!-- <img
                                    class="avatar"
                                    src="assets/images/avatars/profile.jpg"
                                    alt=""
                                /> -->
                                <div class="avatar-info" class="doctorView" (click)="setData(row)" matTooltip="view patient">
                                    <p *ngIf="row.patient_id != null">
                                        {{ row.first_name }} {{ row.last_name }}
                                    </p>
                                    <p *ngIf="row.patient_id == null">-</p>
                                    <span> {{ row.patient_id }}</span>
                                </div>
                            </div>
                            <!-- <p *ngIf="row.patient_id != null">
                                #{{ row.patient_id }}
                            </p>
                            <p *ngIf="row.patient_id == null">-</p> -->
                        </ng-template>
                    </ngx-datatable-column>

                    <!-- <ngx-datatable-column
                        [cellClass]="'text-hidden'"
                        name="Patient Name"
                        [width]="200"
                    >
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <span
                                matTooltip="{{ row.first_name }} {{
                                    row.last_name
                                }}"
                            >
                                <p *ngIf="row.patient_id != null">
                                    {{ row.first_name }} {{ row.last_name }}
                                </p>
                                <p *ngIf="row.patient_id == null">-</p>
                            </span>
                        </ng-template>
                    </ngx-datatable-column> -->

                    <ngx-datatable-column name="Type of alert" [width]="200">
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <p>
                                {{ row.alert_type }}
                            </p>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column name="Description" [width]="250">
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <p>
                                {{ row.description }}
                            </p>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column
                        name="Resolution Status"
                        [width]="200"
                    >
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <p
                                *ngIf="row.alertsStatus == 1"
                                style="color: #2ac770"
                            >
                                {{ row.status }}
                            </p>
                            <p
                                *ngIf="row.alertsStatus == 0"
                                style="color: #ea5455"
                            >
                                {{ row.status }}
                            </p>
                        </ng-template>
                    </ngx-datatable-column>

                    <ngx-datatable-column
                        name="Action"
                        [sortable]="false"
                        [width]="100"
                    >
                        <ng-template
                            let-row="row"
                            let-rowIndex="rowIndex"
                            ngx-datatable-cell-template
                        >
                            <button
                                mat-icon-button
                                class="view-btn"
                                matTooltip="View"
                                (click)="updateAlertDialog(row)"
                            >
                                <mat-icon>visibility</mat-icon>
                            </button>
                        </ng-template>
                    </ngx-datatable-column>
                </ngx-datatable>
            </div>
            <mat-paginator
                #paginatorAlert
                style="background: #f1f2f8"
                [length]="totalAlert"
                [pageSize]="requestParamAlert.pasgesize"
                [pageSizeOptions]="[5, 10, 25, 100]"
                (page)="getServerData($event)"
                aria-label="Select page"
            >
            </mat-paginator>
        </div>
    </div>
</div>

<ng-template #updateResolve>
    <div class="dialog-content-wrapper">
        <div class="alert-modal">
            <div class="modal-header">
                <h2>
                    Alert for {{ selectedRow.first_name }}
                    {{ selectedRow.last_name }}
                </h2>

                <span
                    class="alert-tag-green"
                    *ngIf="selectedRow.alertsStatus == 1"
                >
                    Resolved Alert
                </span>
                <span class="alert-tag" *ngIf="selectedRow.alertsStatus == 0">
                    Unresolved Alert
                </span>
            </div>
            <div class="modal-body">
                <div class="blood-pressure-block">
                    <div class="block-header">
                        <label>Blood Pressure</label>
                        <span
                            >{{ selectedRow.last_alert | date: "MMM dd, yyyy" }}
                        </span>

                        <span class="ml-4">{{
                            selectedRow.last_alert | date: " h:mm a"
                        }}</span>
                    </div>
                    <div class="block-item">
                        <i class="icon"></i>
                        <p>
                            {{ selectedRow.description }}
                            <!-- Systolic <strong>7 mmHg</strong> higher than
                            threshold -->
                        </p>
                    </div>
                </div>
                <div class="notes-field input-block">
                    <mat-form-field appearance="fill" class="w-full">
                        <mat-label>Add Notes</mat-label>
                        <textarea
                            rows="4"
                            matInput
                            [(ngModel)]="alertNotes"
                            maxlength="120"
                            style="resize: none"
                            >{{ selectedRow.notes }}</textarea
                        >
                    </mat-form-field>
                </div>
            </div>
            <div class="form-action mt-2">
                <button
                    mat-stroked-button
                    class="cancel-btn"
                    (click)="cancelPopup()"
                >
                    Cancel
                </button>
                <button
                    mat-flat-button
                    color="primary"
                    class="next-btn"
                    (click)="resolveAct(1, selectedRow.alertsUuid)"
                    *ngIf="selectedRow.alertsStatus == 0"
                >
                    Resolve
                </button>

                <button
                    mat-flat-button
                    color="primary"
                    class="next-btn"
                    (click)="resolveAct(0, selectedRow.alertsUuid)"
                    *ngIf="selectedRow.alertsStatus == 1"
                    style="background-color: #ea5455"
                >
                    Unresolve
                </button>
            </div>
        </div>
    </div>
</ng-template>
